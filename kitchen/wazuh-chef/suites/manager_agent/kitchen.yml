---
driver:
  name: docker
  privileged: true
  use_sudo: false
  use_internal_docker_network: true

provisioner:
  name: chef_zero
  chef_license: accept-no-persist

platforms:
  - name: <%= ENV['PLATFORM'] %>_<%= ENV['RELEASE'] %>_kitchen_chef
    driver_config:
      image: <%= ENV['IMAGE'] %>
      platform: <%= ENV['PLATFORM'] %>
      forward: 443
      publish_all: true
      privileged: true
      volume:
        - /sys/fs/cgroup:/sys/fs/cgroup:ro
      provision_command:
        - sed -i 's/UsePAM yes/UsePAM no/g' /etc/ssh/sshd_config
suites:
  - name: manager
    environments_path: ../wazuh_manager/test/environments
    data_bags_path: ../wazuh_manager/test/data_bags
    encrypted_data_bag_secret_key_path: ../wazuh_manager/test/data_bags/wazuh_secrets/test_data_bag_key
    driver:
    run_list:
      - recipe[test::test]
      - recipe[wazuh_manager::repository]
      - recipe[wazuh_manager::manager]
      - recipe[wazuh_filebeat::default]
    attributes:
    provisioner:
      client_rb:
        environment: development-master
    verifier:
      name: shell
      command: py.test -v test/base/*manager*

  - name: agent
    environments_path: ../wazuh_agent/test/environments
    data_bags_path: ../wazuh_agent/test/data_bags
    encrypted_data_bag_secret_key_path: ../wazuh_agent/test/data_bags/wazuh_secrets/test_data_bag_key
    driver:
    run_list:
      - recipe[test::test]
      - recipe[wazuh_agent::repository]
      - recipe[wazuh_agent::agent]
    attributes:
         vagrant:
    provisioner:
      client_rb:
        environment: development
    verifier:
      name: shell
      command: py.test -v test/base/*agent*