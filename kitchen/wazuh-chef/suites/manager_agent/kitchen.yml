---
driver:
  name: docker
  use_sudo: false
  use_internal_docker_network: true
  remove_images: true
  use_cache: false

provisioner:
  name: chef_zero
  chef_license: accept-no-persist

platforms:
  - name: <%= ENV['PLATFORM'] %>_<%= ENV['RELEASE'] %>_kitchen_chef
    driver_config:
      image: <%= ENV['IMAGE'] %>
      platform: <%= ENV['PLATFORM'] %>
      publish_all: true
      run_command: <%= ENV['RUN_COMMAND'] %>
      privileged: true
      volume:
        - /sys/fs/cgroup:/sys/fs/cgroup:ro
      provision_command:
        - sed -i 's/UsePAM yes/UsePAM no/g' /etc/ssh/sshd_config
        - awk -F= '/^NAME/{print $2}' /etc/os-release | grep -qi 'debian\|ubuntu' && apt-get install -y apt-transport-https gnupg2 ca-certificates|| yum install -y openssl

suites:
  - name: manager
    environments_path: <%= ENV['COOKBOOKS_PATH'] %>/wazuh_manager/test/environments
    data_bags_path: <%= ENV['COOKBOOKS_PATH'] %>/wazuh_manager/test/data_bags
    encrypted_data_bag_secret_key_path: <%= ENV['COOKBOOKS_PATH'] %>/wazuh_manager/test/data_bags/wazuh_secrets/test_data_bag_key
    driver:
    run_list:
      - recipe[load_attributes::load_attributes]
      - recipe[wazuh_manager::repository]
      - recipe[wazuh_manager::manager]
    attributes:
    provisioner:
      client_rb:
        environment: development-master
    verifier:
      name: shell
      command: py.test -v test/base/*manager*

  - name: agent
    environments_path: <%= ENV['COOKBOOKS_PATH'] %>/wazuh_agent/test/environments
    data_bags_path: <%= ENV['COOKBOOKS_PATH'] %>/wazuh_agent/test/data_bags
    encrypted_data_bag_secret_key_path: <%= ENV['COOKBOOKS_PATH'] %>/wazuh_agent/test/data_bags/wazuh_secrets/test_data_bag_key
    driver:
    run_list:
      - recipe[load_attributes::load_attributes]
      - recipe[wazuh_agent::repository]
      - recipe[wazuh_agent::agent]
    attributes:
         vagrant:
    provisioner:
      client_rb:
        environment: development
    verifier:
      name: shell
      command: py.test -v test/base/*agent*
