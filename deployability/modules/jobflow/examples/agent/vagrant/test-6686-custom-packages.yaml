version: 0.1
description: This workflow is used to test agents deployment for DDT1 PoC
variables:
  agent-os:
    - linux-ubuntu-22.04-amd64
    - linux-debian-11-arm64
    - linux-redhat-7-amd64
    - linux-centos-8-arm64
    - linux-amazon-2-amd64

  windows-agent-os:
    - windows-server-2022-amd64

  macos-agent-os:
    - macos-ventura-13-amd64

  manager-os: linux-ubuntu-22.04-amd64
  infra-provider: vagrant
  working-dir: /tmp/dtt1-poc

tasks:
  # Unique manager allocate task
  - task: "allocate-manager-{manager-os}"
    description: "Allocate resources for the manager."
    do:
      this: process
      with:
        path: python3
        args:
          - modules/allocation/main.py
          - action: create
          - provider: "{infra-provider}"
          - size: large
          - composite-name: "{manager-os}"
          - inventory-output: "{working-dir}/manager-{manager-os}/inventory.yaml"
          - track-output: "{working-dir}/manager-{manager-os}/track.yaml"
          - label-termination-date: "1d"
          - label-team: "qa"
          - label-issue: "https://github.com/wazuh/wazuh-jenkins/issues/6686"
    cleanup:
      this: process
      with:
        path: python3
        args:
          - modules/allocation/main.py
          - action: delete
          - track-output: "{working-dir}/manager-{manager-os}/track.yaml"

  # Unique agent allocate task
  - task: "allocate-agent-{agent}"
    description: "Allocate resources for the agent."
    do:
      this: process
      with:
        path: python3
        args:
          - modules/allocation/main.py
          - action: create
          - provider: "{infra-provider}"
          - size: small
          - composite-name: "{agent}"
          - inventory-output: "{working-dir}/agent-{agent}/inventory.yaml"
          - track-output: "{working-dir}/agent-{agent}/track.yaml"
          - label-termination-date: "1d"
          - label-team: "qa"
          - label-issue: "https://github.com/wazuh/wazuh-jenkins/issues/6686"
    foreach:
      - variable: agent-os
        as: agent
    cleanup:
      this: process
      with:
        path: python3
        args:
          - modules/allocation/main.py
          - action: delete
          - track-output: "{working-dir}/agent-{agent}/track.yaml"

  # Generic agent test task
  - task: "run-agent-{agent}-tests"
    description: "Run tests install for the agent {agent}."
    do:
      this: process
      with:
        path: python3
        args:
          - modules/testing/main.py
          - targets:
            - wazuh-1: "{working-dir}/manager-{manager-os}/inventory.yaml"
            - agent: "{working-dir}/agent-{agent}/inventory.yaml"
          - tests: "install,connection,basic_info,restart,stop,uninstall"
          - component: "agent"
          - wazuh-version: "4.8.0"
          - wazuh-revision: "40800"
          - live: True
          - custom-packages:
            - manager-deb: "https://packages-dev.wazuh.com/trash/apt/pool/main/w/wazuh-manager/wazuh-manager_4.8.0-wj5952_amd64.deb"
            - agent-deb: "https://packages-dev.wazuh.com/trash/apt/pool/main/w/wazuh-agent/wazuh-agent_4.7.3-wj6321_amd64.deb"
            - agent-rpm: "https://packages-dev.wazuh.com/trash/yum/wazuh-agent-4.7.3-wj6321.x86_64.rpm"
    foreach:
      - variable: agent-os
        as: agent
    depends-on:
      - "allocate-agent-{agent}"

  # # Unique agent allocate task
  # - task: "allocate-windows-agent-{agent}"
  #   description: "Allocate resources for the agent."
  #   do:
  #     this: process
  #     with:
  #       path: python3
  #       args:
  #         - modules/allocation/main.py
  #         - action: create
  #         - provider: "{infra-provider}"
  #         - size: large
  #         - composite-name: "{agent}"
  #         - inventory-output: "{working-dir}/agent-{agent}/inventory.yaml"
  #         - track-output: "{working-dir}/agent-{agent}/track.yaml"
  #         - label-termination-date: "1d"
  #         - label-team: "qa"
  #         - label-issue: "https://github.com/wazuh/wazuh-jenkins/issues/6686"
  #   foreach:
  #     - variable: windows-agent-os
  #       as: agent
  #   cleanup:
  #     this: process
  #     with:
  #       path: python3
  #       args:
  #         - modules/allocation/main.py
  #         - action: delete
  #         - track-output: "{working-dir}/agent-{agent}/track.yaml"

  # # Generic agent test task
  # - task: "run-windows-agent-{agent}-tests"
  #   description: "Run tests install for the agent {agent}."
  #   do:
  #     this: process
  #     with:
  #       path: python3
  #       args:
  #         - modules/testing/main.py
  #         - targets:
  #           - wazuh-1: "{working-dir}/manager-{manager-os}/inventory.yaml"
  #           - agent: "{working-dir}/agent-{agent}/inventory.yaml"
  #         - tests: "install,registration,connection,basic_info,restart,stop,uninstall"
  #         - component: "agent"
  #         - wazuh-version: "4.7.2"
  #         - wazuh-revision: "40711"
  #         - live: False
  #         - custom-packages:
  #           - agent-msi: "https://packages-dev.wazuh.com/trash/windows/wazuh-agent-4.7.2-0.1.4.todelete.msi"
  #   foreach:
  #     - variable: windows-agent-os
  #       as: agent
  #   depends-on:
  #     - "allocate-windows-agent-{agent}"

  # # Unique agent allocate task
  # - task: "allocate-macos-agent-{agent}"
  #   description: "Allocate resources for the agent."
  #   do:
  #     this: process
  #     with:
  #       path: python3
  #       args:
  #         - modules/allocation/main.py
  #         - action: create
  #         - provider: "{macos-infra-provider}"
  #         - size: small
  #         - composite-name: "{agent}"
  #         - inventory-output: "{working-dir}/agent-{agent}/inventory.yaml"
  #         - track-output: "{working-dir}/agent-{agent}/track.yaml"
  #         - label-termination-date: "1d"
  #         - label-team: "qa"
  #         - label-issue: "https://github.com/wazuh/wazuh-jenkins/issues/6686"
  #   foreach:
  #     - variable: macos-agent-os
  #       as: agent
  #   cleanup:
  #     this: process
  #     with:
  #       path: python3
  #       args:
  #         - modules/allocation/main.py
  #         - action: delete
  #         - track-output: "{working-dir}/agent-{agent}/track.yaml"

  # # Generic agent test task
  # - task: "run-macos-agent-{agent}-tests"
  #   description: "Run tests install for the agent {agent}."
  #   do:
  #     this: process
  #     with:
  #       path: python3
  #       args:
  #         - modules/testing/main.py
  #         - targets:
  #           - wazuh-1: "{working-dir}/manager-{manager-os}/inventory.yaml"
  #           - agent: "{working-dir}/agent-{agent}/inventory.yaml"
  #         - tests: "install,registration,connection,basic_info,restart,stop,uninstall"
  #         - component: "agent"
  #         - wazuh-version: "4.7.1"
  #         - wazuh-revision: "40709"
  #         - live: False
  #         - custom_packages:
  #           - agent-pkg: "https://packages-dev.wazuh.com/trash/macos/wazuh-agent-4.7.1-0.0.0.todelete.intel64.pkg"
  #   foreach:
  #     - variable: macos-agent-os
  #       as: agent
  #   depends-on:
  #     - "allocate-macos-agent-{agent}"
