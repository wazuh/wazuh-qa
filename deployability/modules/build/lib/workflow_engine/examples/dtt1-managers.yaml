# Copyright (C) 2015, Wazuh Inc.
# Created by Wazuh, Inc. <info@wazuh.com>.
# This program is a free software; you can redistribute it and/or modify it under the terms of GPLv2
version: 0.1
description: This workflow is used to test managers deployment. Two agents per manager are deployed.
variables:
  agents-os: 
    - linux-debian-12-amd64
    - linux-ubuntu-22.04-amd64
  managers-os:
    - linux-redhat-7-amd64
    - linux-redhat-8-amd64
    - linux-redhat-9-amd64
    - linux-centos-7-amd64
    - linux-centos-8-amd64
    - linux-debian-10-amd64
    - linux-debian-11-amd64
    - linux-debian-12-amd64
    - linux-ubuntu-18.04-amd64
    - linux-ubuntu-20.04-amd64
    - linux-ubuntu-22.04-amd64
    - linux-fedora-37-amd64
    - linux-fedora-38-amd64
    - linux-suse-15-amd64
    - linux-opensuse-15-amd64
    - linux-oracle-9-amd64
    - linux-amazon-2-amd64
    - linux-amazon-2023-amd64
tasks:
  # Generic manager test task
  - task: "test-{manager}-{agent}"
    do:
      this: process
      with:
        path: /bin/echo
        args:
          - Executing tests for {manager} manager with {agent} agent.
    depends-on:
      - "provision-{manager}-manager"
      - "provision-{agent}-agent-for-{manager}-manager"
    foreach:
      - variable: managers-os
        as: manager
      - variable: agents-os
        as: agent

  # --------- Provision --------------
  # Generic manager provision task
  - task: "provision-{manager}-manager"
    do:
      this: process
      with:
        path: /bin/echo
        args:
          - Executing provision for {manager} as a manager.
    depends-on:
      - "allocate-{manager}-manager"
    foreach:
      - variable: managers-os
        as: manager

  # Generic agent provision task
  - task: "provision-{agent}-agent-for-{manager}-manager"
    do:
      this: process
      with:
        path: /bin/echo
        args:
          - Executing provision for {agent} as an agent.
    depends-on:
      - "allocate-{agent}-agent-for-{manager}-manager"
    foreach:
      - variable: managers-os
        as: manager
      - variable: agents-os
        as: agent

  # --------- Allocate --------------
  # Generic manager allocate task
  - task: "allocate-{manager}-manager"
    do:
      this: process
      with:
        path: /bin/echo
        args:
          - Executing allocation for {manager} as a manager.
    foreach:
      - variable: managers-os
        as: manager

  # Generic agent allocate task
  - task: "allocate-{agent}-agent-for-{manager}-manager"
    do:
      this: process
      with:
        path: /bin/echo
        args:
          - Executing allocation for {agent} as an agent.
    foreach:
      - variable: managers-os
        as: manager
      - variable: agents-os
        as: agent
