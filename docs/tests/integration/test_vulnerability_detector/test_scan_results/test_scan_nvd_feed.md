# Test scan NVD feed

These tests will mock RedHat, Canonical, Debian, and Windows systems, and insert custom vulnerabilities and vulnerable
packages to check if Vulnerability Detector generates the vulnerability alerts from NVD feed.

## General info

|Tier | Number of tests | Time spent| Test file |
|:--:|:--:|:--:|:--:|
| 0 | 12 | 0:04:24 | [test_scan_nvd_feed.py](../../test_scan_results/test_scan_nvd_feed.py)|

## Test logic

For each of these systems:

```
Red Hat --> RHEL8, RHEL7, RHEL6, RHEL5
Debian --> BUSTER, STRETCH, JESSIE, WHEEZY
Ubuntu --> BIONIC, XENIAL, TRUSTY
Windows --> WINDOWS10
```

The test will run these actions
- Clean NVD, `vulnerabilities`, and `sys_programs tables`.
- Mock the system.
- If the mocked system is *Windows*:
  - `vd.insert_osinfo()`.
  - `vd.insert_hotfix()`.
- Insert a dummy vulnerability in the `vulnerabilities` table and mock an imported feed from a provider.
- Insert **simulated** NVD [vulnerable packages](../../test_scan_results/data/vulnerabilities.json)
- Import **simulated** NVD vulnerabilities from [custom NVD feed](../../test_scan_results/data/custom_nvd_feed.json).
- Check these events in `ossec.log`:

  - If *Windows*:

    ```
    Agent '000' is vulnerable to '{cve}'. Condition: '{patch} patch is not installed.'
    ```

  - If *Red Hat*, then the alert is not checked, because it is disabled

  - For other systems:

    ```
    The '{package}' package .* from agent .* is vulnerable to '{cve}'
    ```

  - Finally, for all the systems it is checked:

    ```
    The NVD found a total of '{vulnerabilities_number}' potential vulnerabilities for agent .*
    ```

## Checks

- [x] There are as many NVD alerts as vulnerable packages.
- [x] There are 0 NVD vulnerability alerts for RedHat provider.
- [x] The alerts are produced by the NVD provider.

## Observed behaviour

The expected behaviour is carried out.

## Execution result

```
========================================= test session starts ==========================================
platform linux -- Python 3.7.3, pytest-5.4.2, py-1.8.1, pluggy-0.13.1
rootdir: /root/wazuh-qa/tests/integration, inifile: pytest.ini
plugins: html-2.0.1, metadata-1.9.0, testinfra-5.0.0
collected 12 items

test_vulnerability_detector/test_scan_results/test_scan_nvd_feed.py ............                 [100%]

==================================== 12 passed in 264.82s (0:04:24) ====================================
```

## Code documentation

::: tests.integration.test_vulnerability_detector.test_scan_results.test_scan_nvd_feed