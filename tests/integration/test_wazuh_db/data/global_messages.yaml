---
-
  name: "Insert commands"
  description: "Check success use cases for insert commands on global DB"
  test_case:
  -
    input: 'global delete-group TestGroup1'
    output: "ok"
    stage: "global delete-group previous insert"
  -
    input: 'global find-group TestGroup1'
    output: "ok []"
    stage: "global find-group previous insert"
  -
    input: 'global insert-agent-group TestGroup1'
    output: 'ok'
    stage: "global insert-agent-group success"
  -
    input: 'global find-group default'
    output: 'ok [{"id":*}]'
    stage: "global find-group after insert"
    use_regex: "yes"
  -
    input: 'global find-group TestGroup1'
    output: 'ok [{"id":*}]'
    stage: "global find-group after insert"
    use_regex: "yes"
  -
    input: 'global select-groups'
    output: 'ok [{"name":"default"},{"name":"TestGroup1"}]'
    stage: "global select-groups success"
  -
    input: 'global delete-agent 1'
    output: "ok"
    stage: "global delete-agent previous insert"
  -
    input: 'global get-agent-info 1'
    output: 'ok []'
    stage: "global get-agent-info previous insert"
  -
    input: 'global insert-agent {"id":1,"name":"TestName1","ip":"0.0.0.1","register_ip":"0.0.0.1","internal_key":"TopSecret","group":"TestGroup1","date_add":1599223378}'
    output: "ok"
    stage: "global insert-agent success"
  -
    input: 'global get-agent-info 1'
    output: 'ok [{"id":1,"name":"TestName1","ip":"0.0.0.1","register_ip":"0.0.0.1","internal_key":"TopSecret","node_name":"unknown","date_add":1599223378,"status":"empty","fim_offset":0,"reg_offset":0,"group":"TestGroup1","sync_status":"synced","connection_status":"never_connected"}]'
    stage: "global get-agent-info after insert"
  -
    input: 'global find-agent {"name":"TestName1","ip":"0.0.0.1"}'
    output: 'ok [{"id":1}]'
    stage: "global find-agent success"
  -
    input: 'global delete-agent 2'
    output: "ok"
    stage: "global delete-agent previous insert"
  -
    input: 'global insert-agent {"id":2,"name":"TestName2","date_add":1599223378}'
    output: "ok"
    stage: "global insert-agent minimal fields success"
  -
    input: 'global get-agent-info 2'
    output: 'ok [{"id":2,"name":"TestName2","node_name":"unknown","date_add":1599223378,"status":"empty","fim_offset":0,"reg_offset":0,"sync_status":"synced","connection_status":"never_connected"}]'
    stage: "global get-agent-info after minimal fields insert"
  -
    input: 'global delete-agent 2'
    output: "ok"
    stage: "global delete-agent after insert"
  -
    input: 'global insert-agent {"id":2,"name":"TestName2","date_add":1599223378}'
    output: "ok"
    stage: "global insert-agent agent 2 again after delete"
-
  name: "Update commands"
  description: "Check success use cases for update commands on global DB"
  test_case:
  -
    input: 'global update-agent-name {"id":1,"name":"TestName2"}'
    output: "ok"
    stage: "global update-agent-name success"
  -
    input: 'global update-agent-data {"id":1,"os_name":"TestOsName","os_version":"TestOsVersion","os_major":"TestOsMajor","os_minor":"TestOsMinor","os_codename":"TestOsCodeName","os_platform":"TestOsPlatfor","os_build":"TestOsBuild","os_uname":"TestOsUname","os_arch":"TestOsArch","version":"TestVersion","config_sum":"TestConfigSum","merged_sum":"TestMergedSum","manager_host":"TestManagerHost","node_name":"TestNodeName","agent_ip":"0.0.0.1","sync_status":"syncreq","labels":"TestKey1:TestLabel1"}'
    output: "ok"
    stage: "global update-agent-data success"
  -
    input: 'global update-agent-status {"id":1,"status":"updated"}'
    output: "ok"
    stage: "global update-agent-status success"
  -
    input: 'global update-agent-group {"id":1,"group":"TestGroup2"}'
    output: "ok"
    stage: "global update-agent-group success"
  -
    input: 'global update-fim-offset {"id":1,"offset":100}'
    output: "ok"
    stage: "global update-fim-offset success"
  -
    input: 'global update-reg-offset {"id":1,"offset":100}'
    output: "ok"
    stage: "global update-reg-offset success"
  -
    input: 'global update-keepalive {"id":1,"sync_status":"syncreq"}'
    output: "ok"
    stage: "global update-keepalive success"
  -
    input: 'global get-agent-info 1'
    output: 'ok [{"id":1,"name":"TestName2","ip":"0.0.0.1","register_ip":"0.0.0.1","internal_key":"TopSecret","os_name":"TestOsName","os_version":"TestOsVersion","os_major":"TestOsMajor","os_minor":"TestOsMinor","os_codename":"TestOsCodeName","os_build":"TestOsBuild","os_platform":"TestOsPlatfor","os_uname":"TestOsUname","os_arch":"TestOsArch","version":"TestVersion","config_sum":"TestConfigSum","merged_sum":"TestMergedSum","manager_host":"TestManagerHost","node_name":"TestNodeName","date_add":1599223378,"last_keepalive":*,"status":"updated","fim_offset":100,"reg_offset":100,"group":"TestGroup2","sync_status":"syncreq","connection_status":"never_connected"}]'
    stage: "global get-agent-info success after updates"
    use_regex: "yes"
  -
    input: 'global update-connection-status {"id":1,"connection_status":"pending"}'
    output: "ok"
    stage: "global update-connection-status pending success"
  -
    input: 'global get-agent-info 1'
    output: 'ok [{"id":1,"name":"TestName2","ip":"0.0.0.1","register_ip":"0.0.0.1","internal_key":"TopSecret","os_name":"TestOsName","os_version":"TestOsVersion","os_major":"TestOsMajor","os_minor":"TestOsMinor","os_codename":"TestOsCodeName","os_build":"TestOsBuild","os_platform":"TestOsPlatfor","os_uname":"TestOsUname","os_arch":"TestOsArch","version":"TestVersion","config_sum":"TestConfigSum","merged_sum":"TestMergedSum","manager_host":"TestManagerHost","node_name":"TestNodeName","date_add":1599223378,"last_keepalive":*,"status":"updated","fim_offset":100,"reg_offset":100,"group":"TestGroup2","sync_status":"syncreq","connection_status":"pending"}]'
    stage: "global get-agent-info success after updates"
    use_regex: "yes"
  -
    input: 'global update-connection-status {"id":1,"connection_status":"active"}'
    output: "ok"
    stage: "global update-connection-status active success"
  -
    input: 'global get-agent-info 1'
    output: 'ok [{"id":1,"name":"TestName2","ip":"0.0.0.1","register_ip":"0.0.0.1","internal_key":"TopSecret","os_name":"TestOsName","os_version":"TestOsVersion","os_major":"TestOsMajor","os_minor":"TestOsMinor","os_codename":"TestOsCodeName","os_build":"TestOsBuild","os_platform":"TestOsPlatfor","os_uname":"TestOsUname","os_arch":"TestOsArch","version":"TestVersion","config_sum":"TestConfigSum","merged_sum":"TestMergedSum","manager_host":"TestManagerHost","node_name":"TestNodeName","date_add":1599223378,"last_keepalive":*,"status":"updated","fim_offset":100,"reg_offset":100,"group":"TestGroup2","sync_status":"syncreq","connection_status":"active"}]'
    stage: "global get-agent-info success after updates"
    use_regex: "yes"
  -
    input: 'global update-connection-status {"id":1,"connection_status":"disconnected"}'
    output: "ok"
    stage: "global update-connection-status disconnected success"
  -
    input: 'global get-agent-info 1'
    output: 'ok [{"id":1,"name":"TestName2","ip":"0.0.0.1","register_ip":"0.0.0.1","internal_key":"TopSecret","os_name":"TestOsName","os_version":"TestOsVersion","os_major":"TestOsMajor","os_minor":"TestOsMinor","os_codename":"TestOsCodeName","os_build":"TestOsBuild","os_platform":"TestOsPlatfor","os_uname":"TestOsUname","os_arch":"TestOsArch","version":"TestVersion","config_sum":"TestConfigSum","merged_sum":"TestMergedSum","manager_host":"TestManagerHost","node_name":"TestNodeName","date_add":1599223378,"last_keepalive":*,"status":"updated","fim_offset":100,"reg_offset":100,"group":"TestGroup2","sync_status":"syncreq","connection_status":"disconnected"}]'
    stage: "global get-agent-info success after updates"
    use_regex: "yes"
  -
    input: 'global update-connection-status {"id":1,"connection_status":"dummy_status"}'
    output: "err Cannot execute Global database query; CHECK constraint failed: agent"
    stage: "global update-connection-status dummy_status error"
  -
    input: 'global get-agent-info 1'
    output: 'ok [{"id":1,"name":"TestName2","ip":"0.0.0.1","register_ip":"0.0.0.1","internal_key":"TopSecret","os_name":"TestOsName","os_version":"TestOsVersion","os_major":"TestOsMajor","os_minor":"TestOsMinor","os_codename":"TestOsCodeName","os_build":"TestOsBuild","os_platform":"TestOsPlatfor","os_uname":"TestOsUname","os_arch":"TestOsArch","version":"TestVersion","config_sum":"TestConfigSum","merged_sum":"TestMergedSum","manager_host":"TestManagerHost","node_name":"TestNodeName","date_add":1599223378,"last_keepalive":*,"status":"updated","fim_offset":100,"reg_offset":100,"group":"TestGroup2","sync_status":"syncreq","connection_status":"disconnected"}]'
    stage: "global get-agent-info success after updates"
    use_regex: "yes"
-
  name: "Labels commands"
  description: "Check success use cases for labels table commands on global DB"
  test_case:
  -
    input: 'global get-labels 1'
    output: 'ok [{"id":1,"key":"TestKey1","value":"TestLabel1"}]'
    stage: "global get-labels success"
  -
    input: 'global set-labels 1 TestKey2:TestLabel2'
    output: 'ok'
    stage: "global set-labels success"
  -
    input: 'global get-labels 1'
    output: 'ok [{"id":1,"key":"TestKey2","value":"TestLabel2"}]'
    stage: "global get-labels success"
-
  name: "Select commands"
  description: "Check success use cases for select commands on global DB"
  test_case:
  -
    input: 'global select-agent-name 1'
    output: 'ok [{"name":"TestName2"}]'
    stage: "global select-agent-name success"
  -
    input: 'global select-agent-group  1'
    output: 'ok [{"group":"TestGroup2"}]'
    stage: "global select-agent-group success"
  -
    input: 'global select-agent-status 1'
    output: 'ok [{"status":"updated"}]'
    stage: "global select-agent-status success"
  -
    input: 'global select-fim-offset 1'
    output: 'ok [{"fim_offset":100}]'
    stage: "global select-fim-offset success"
  -
    input: 'global select-reg-offset 1'
    output: 'ok [{"reg_offset":100}]'
    stage: "global select-reg-offset success"
  -
    input: 'global select-keepalive TestName2 0.0.0.1'
    output: 'ok [{"last_keepalive":*}]'
    stage: "global select-keepalive success"
    use_regex: "yes"
  -
    input: 'global select-groups'
    output: 'ok [{"name":"default"},{"name":"TestGroup1"}]'
    stage: "global select-groups success"
-
  name: "get-all-agents command"
  description: "Check success use cases for get-all-agents command on global DB. Chunks command"
  test_case:
  -
    input: 'global get-all-agents last_id -1'
    output: 'ok 0,1,2'
    stage: "global get-all-agents success"
-
  name: "get-agents-by-keepalive command"
  description: "Check success use cases for get-agents-by-keepalive command on global DB. Chunks command"
  test_case:
  -
    input: 'global get-agents-by-keepalive condition > 100 last_id 0'
    output: 'ok 1'
    stage: "global get-agents-by-keepalive success"
  -
    input: 'global get-agents-by-keepalive condition < 100 last_id 0'
    output: 'ok '
    stage: "global get-agents-by-keepalive success"
-
  name: "sync-agent-info-get command"
  description: "Check success use cases for sync-agent-info-get command on global DB. Chunks command"
  test_case:
  -
    input: 'global sync-agent-info-get last_id 0'
    output: 'ok [{"id":1,"name":"TestName2","ip":"0.0.0.1","os_name":"TestOsName","os_version":"TestOsVersion","os_major":"TestOsMajor","os_minor":"TestOsMinor","os_codename":"TestOsCodeName","os_build":"TestOsBuild","os_platform":"TestOsPlatfor","os_uname":"TestOsUname","os_arch":"TestOsArch","version":"TestVersion","config_sum":"TestConfigSum","merged_sum":"TestMergedSum","manager_host":"TestManagerHost","node_name":"TestNodeName","last_keepalive":*,"labels":[{"id":1,"key":"TestKey2","value":"TestLabel2"}]}]'
    stage: "global sync-agent-info-get success"
    use_regex: 'yes'
  -
    input: 'global sync-agent-info-get last_id 0'
    output: 'ok []'
    stage: "global sync-agent-info-get after first get success"
  -
    input: 'global update-keepalive {"id":1,"sync_status":"syncreq"}'
    output: "ok"
    stage: "global update-keepalive success"
  -
    input: 'global sync-agent-info-get'
    output: 'ok [{"id":1,"name":"TestName2","ip":"0.0.0.1","os_name":"TestOsName","os_version":"TestOsVersion","os_major":"TestOsMajor","os_minor":"TestOsMinor","os_codename":"TestOsCodeName","os_build":"TestOsBuild","os_platform":"TestOsPlatfor","os_uname":"TestOsUname","os_arch":"TestOsArch","version":"TestVersion","config_sum":"TestConfigSum","merged_sum":"TestMergedSum","manager_host":"TestManagerHost","node_name":"TestNodeName","last_keepalive":*,"labels":[{"id":1,"key":"TestKey2","value":"TestLabel2"}]}]'
    stage: "global sync-agent-info-get no arg success"
    use_regex: 'yes'
-
  name: "sync-agent-info-set command"
  description: "Check success use cases for sync-agent-info-get command on global DB."
  test_case:
  -
    input: 'global sync-agent-info-set [{"id":3,"name":"TestName3","ip":"0.0.0.3","os_name":"TestOsName","os_version":"TestOsVersion","os_major":"TestOsMajor","os_minor":"TestOsMinor","os_codename":"TestOsCodeName","os_build":"TestOsBuild","os_platform":"TestOsPlatfor","os_uname":"TestOsUname","os_arch":"TestOsArch","config_sum":"TestConfigSum","merged_sum":"TestMergedSum","manager_host":"TestManagerHost","node_name":"TestNodeName","last_keepalive":200}]'
    output: 'ok'
    stage: "global sync-agent-info-set non-existent agent"
  -
    input: 'global get-agent-info 3'
    output: 'ok []'
    stage: "global get-agent-info success after non-existent sync-agent-info-set"
  -
    input: 'global delete-agent 3'
    output: "ok"
    stage: "global delete-agent previous insert"
  -
    input: 'global insert-agent {"id":3,"name":"TestName3","ip":"0.0.0.3","register_ip":"0.0.0.3","internal_key":"TopSecret","date_add":1599223378}'
    output: "ok"
    stage: "global insert-agent success"
  -
    input: 'global sync-agent-info-set [{"id":3,"name":"TestName3","ip":"0.0.0.3","os_name":"TestOsName","os_version":"TestOsVersion","os_major":"TestOsMajor","os_minor":"TestOsMinor","os_codename":"TestOsCodeName","os_build":"TestOsBuild","os_platform":"TestOsPlatfor","os_uname":"TestOsUname","os_arch":"TestOsArch","config_sum":"TestConfigSum","merged_sum":"TestMergedSum","manager_host":"TestManagerHost","node_name":"TestNodeName","last_keepalive":200}]'
    output: 'ok'
    stage: "global sync-agent-info-set success"
  -
    input: 'global get-agent-info 3'
    output: 'ok [{"id":3,"name":"TestName3","ip":"0.0.0.3","register_ip":"0.0.0.3","internal_key":"TopSecret","os_name":"TestOsName","os_version":"TestOsVersion","os_major":"TestOsMajor","os_minor":"TestOsMinor","os_codename":"TestOsCodeName","os_build":"TestOsBuild","os_platform":"TestOsPlatfor","os_uname":"TestOsUname","os_arch":"TestOsArch","config_sum":"TestConfigSum","merged_sum":"TestMergedSum","manager_host":"TestManagerHost","node_name":"TestNodeName","date_add":1599223378,"last_keepalive":200,"status":"empty","fim_offset":0,"reg_offset":0,"sync_status":"synced","connection_status":"never_connected"}]'
    stage: "global get-agent-info success after sync-agent-info-set success"
-
  name: "Belongs commands"
  description: "Check success use cases for belongs table commands on global DB"
  test_case:
  -
    input: 'global insert-agent-belong {"id_group":1,"id_agent":1}'
    output: 'ok'
    stage: "global insert-agent-belong success"
  -
    input: 'global delete-agent-belong 1'
    output: 'ok'
    stage: "global delete-agent-belong success"
  -
    input: 'global insert-agent-belong {"id_group":1,"id_agent":1}'
    output: 'ok'
    stage: "global insert-agent-belong success"
-
  name: "Reset connection status"
  description: "Check success use cases for reset connection status command."
  test_case:
  -
    input: 'global update-connection-status {"id":1,"connection_status":"pending"}'
    output: "ok"
    stage: "global update-connection-status pending success"
  -
    input: 'global update-connection-status {"id":3,"connection_status":"active"}'
    output: "ok"
    stage: "global update-connection-status active success"
  -
    input: 'global reset-agents-connection'
    output: 'ok'
    stage: "global reset-agents-connection success"
    test: 'yes'
  -
    input: 'global get-agent-info 0'
    output: 'ok [{"id":0,*,"last_keepalive":253402300799,"status":"*","fim_offset":0,"reg_offset":0,"sync_status":"synced","connection_status":"active"}]'
    stage: "global manager get-agent-info success post reset connection status"
    use_regex: "yes"
  -
    input: 'global get-agent-info 1'
    output: 'ok [{"id":1,"name":"TestName2","ip":"0.0.0.1","register_ip":"0.0.0.1","internal_key":"TopSecret","os_name":"TestOsName","os_version":"TestOsVersion","os_major":"TestOsMajor","os_minor":"TestOsMinor","os_codename":"TestOsCodeName","os_build":"TestOsBuild","os_platform":"TestOsPlatfor","os_uname":"TestOsUname","os_arch":"TestOsArch","version":"TestVersion","config_sum":"TestConfigSum","merged_sum":"TestMergedSum","manager_host":"TestManagerHost","node_name":"TestNodeName","date_add":1599223378,"last_keepalive":*,"status":"updated","fim_offset":100,"reg_offset":100,"group":"TestGroup2","sync_status":"synced","connection_status":"disconnected"}]'
    stage: "global agent get-agent-info success post reset connection status"
    use_regex: "yes"
  -
    input: 'global get-agent-info 2'
    output: 'ok [{"id":2,"name":"TestName2","node_name":"unknown","date_add":1599223378,"status":"empty","fim_offset":0,"reg_offset":0,"sync_status":"synced","connection_status":"never_connected"}]'
    stage: "global agent get-agent-info success post reset connection status"
    use_regex: "yes"
  -
    input: 'global get-agent-info 3'
    output: 'ok [{"id":3,"name":"TestName3","ip":"0.0.0.3","register_ip":"0.0.0.3","internal_key":"TopSecret","os_name":"TestOsName","os_version":"TestOsVersion","os_major":"TestOsMajor","os_minor":"TestOsMinor","os_codename":"TestOsCodeName","os_build":"TestOsBuild","os_platform":"TestOsPlatfor","os_uname":"TestOsUname","os_arch":"TestOsArch","config_sum":"TestConfigSum","merged_sum":"TestMergedSum","manager_host":"TestManagerHost","node_name":"TestNodeName","date_add":1599223378,"last_keepalive":200,"status":"empty","fim_offset":0,"reg_offset":0,"sync_status":"synced","connection_status":"disconnected"}]'
    stage: "global agent get-agent-info success post reset connection status"
    use_regex: "yes"
-
  name: "Delete commands"
  description: "Check success use cases for delete commands on global DB."
  test_case:
  -
    input: 'global delete-group-belong TestGroup1'
    output: 'ok'
    stage: "global delete-group-belong"
  -
    input: 'global delete-group TestGroup1'
    output: "ok"
    stage: "global delete-group after insert"
  -
    input: 'global delete-agent 1'
    output: "ok"
    stage: "global delete-agent after insert"
  -
    input: 'global delete-agent 2'
    output: "ok"
    stage: "global delete-agent after insert"
  -
    input: 'global delete-agent 3'
    output: "ok"
    stage: "global delete-agent after insert"
-
  name: "Manager keepalive"
  description: "Check success use cases for manager keepalive."
  test_case:
  -
    input: 'global get-agent-info 0'
    output: 'ok [{"id":0,*,"last_keepalive":253402300799,"status":"*","fim_offset":0,"reg_offset":0,"sync_status":"synced","connection_status":"active"}]'
    stage: "global manager get-agent-info success pre update"
    use_regex: "yes"
  -
    input: 'global update-agent-data {"id":0,"os_name":"TestOsName","os_version":"TestOsVersion","os_major":"TestOsMajor","os_minor":"TestOsMinor","os_codename":"TestOsCodeName","os_platform":"TestOsPlatfor","os_build":"TestOsBuild","os_uname":"TestOsUname","os_arch":"TestOsArch","version":"TestVersion","config_sum":"TestConfigSum","merged_sum":"TestMergedSum","manager_host":"TestManagerHost","node_name":"TestNodeName","agent_ip":"127.0.0.1","sync_status":"synced"}'
    output: "ok"
    stage: "global manager update-agent-data success"
  -
    input: 'global get-agent-info 0'
    output: 'ok [{"id":0,*,"last_keepalive":253402300799,"status":"*","fim_offset":0,"reg_offset":0,"sync_status":"synced","connection_status":"active"}]'
    stage: "global manager get-agent-info success post update with IP"
    use_regex: "yes"
  -
    input: 'global update-agent-data {"id":0,"os_name":"TestOsName","os_version":"TestOsVersion","os_major":"TestOsMajor","os_minor":"TestOsMinor","os_codename":"TestOsCodeName","os_platform":"TestOsPlatfor","os_build":"TestOsBuild","os_uname":"TestOsUname","os_arch":"TestOsArch","version":"TestVersion","config_sum":"TestConfigSum","merged_sum":"TestMergedSum","manager_host":"TestManagerHost","node_name":"TestNodeName","sync_status":"synced"}'
    output: "ok"
    stage: "global manager update-agent-data success"
  -
    input: 'global get-agent-info 0'
    output: 'ok [{"id":0,*,"last_keepalive":253402300799,"status":"*","fim_offset":0,"reg_offset":0,"sync_status":"synced","connection_status":"active"}]'
    stage: "global manager get-agent-info success post update without IP"
    use_regex: "yes"
