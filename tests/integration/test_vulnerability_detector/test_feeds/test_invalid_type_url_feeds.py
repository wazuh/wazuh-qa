# Copyright (C) 2015-2021, Wazuh Inc.
# Created by Wazuh, Inc. <info@wazuh.com>.
# This program is free software; you can redistribute it and/or modify it under the terms of GPLv2

import os
import tempfile

import pytest
import wazuh_testing.vulnerability_detector as vd
from wazuh_testing.tools import LOG_FILE_PATH
from wazuh_testing.tools.configuration import load_wazuh_configurations
from wazuh_testing.tools.monitoring import FileMonitor

# Marks
pytestmark = pytest.mark.tier(level=1)

# Variables
current_test_path = os.path.dirname(os.path.realpath(__file__))
test_data_path = os.path.join(current_test_path, '..', 'data')
configurations_path = os.path.join(test_data_path, 'configuration', 'test_feeds', 'wazuh_invalid_type_custom_feed.yaml')
files_path = tempfile.gettempdir()

custom_redhat_json_feed_url = 'file://' + os.path.join(test_data_path, 'feeds', vd.CUSTOM_REDHAT_JSON_FEED)
custom_redhat_oval_feed_url = 'file://' + os.path.join(test_data_path, 'feeds', vd.CUSTOM_REDHAT_OVAL_FEED)
custom_canonical_oval_feed_url = 'file://' + os.path.join(test_data_path, 'feeds', vd.CUSTOM_CANONICAL_OVAL_FEED)
custom_debian_oval_feed_url = 'file://' + os.path.join(test_data_path, 'feeds', vd.CUSTOM_DEBIAN_OVAL_FEED)
custom_debian_json_feed_url = 'file://' + os.path.join(test_data_path, 'feeds', vd.CUSTOM_DEBIAN_JSON_FEED)
custom_nvd_json_url = 'file://' + os.path.join(test_data_path, 'feeds', vd.CUSTOM_NVD_FEED)
custom_msu_json_feed_url = 'file://' + os.path.join(test_data_path, 'feeds', vd.CUSTOM_MSU_JSON_FEED)

wazuh_log_monitor = FileMonitor(LOG_FILE_PATH)
url_feeds = [custom_redhat_oval_feed_url, custom_canonical_oval_feed_url, custom_debian_oval_feed_url,
             custom_nvd_json_url, custom_redhat_json_feed_url, custom_debian_json_feed_url, custom_msu_json_feed_url]
correctly_url_feeds = []
for feeds in url_feeds:
    correctly_url_feeds.append(feeds + "")
    correctly_url_feeds.append(feeds + ".gz")
    correctly_url_feeds.append(feeds + ".bz2")

custom_extensions = ['', '.avi', '.doc', '.jpg', '.json', '.xml', '.mp3', '.pdf', '.zip']
custom_correctly_extensions = ['', '.gz', '.bz2']
custom_urls = [f"https://www.customfeed.com/feed{extension}" for extension in custom_extensions]

# Red Hat configurations
redhat_custom_urls = custom_urls + [custom_redhat_oval_feed_url + f"{extension}"
                                    for extension in custom_correctly_extensions]
redhat_configurations = [{'REDHAT_ENABLED': 'yes', 'REDHAT_URL_FEED': custom_url,
                          'REDHAT_JSON_FEED': custom_redhat_json_feed_url, 'CANONICAL_ENABLED': 'no',
                          'DEBIAN_ENABLED': 'no', 'MSU_ENABLED': 'no', 'NVD_ENABLED': 'no'}
                         for custom_url in redhat_custom_urls]
redhat_metadata = [{'feed': 'redhat', 'custom_feed': custom_url, 'log_system_name': 'Red Hat Enterprise Linux 8',
                    'expected_num_vulnerabilities': vd.REDHAT_NUM_CUSTOM_VULNERABILITIES}
                   for custom_url in redhat_custom_urls]
redhat_ids = [f"RedHat_{custom_url}" for custom_url in redhat_custom_urls]

# JSON Red Hat configurations
json_redhat_custom_urls = custom_urls + [custom_redhat_json_feed_url + f"{extension}"
                                         for extension in custom_correctly_extensions]
json_redhat_configurations = [{'REDHAT_ENABLED': 'yes', 'REDHAT_URL_FEED': custom_redhat_oval_feed_url,
                               'REDHAT_JSON_FEED': custom_url, 'CANONICAL_ENABLED': 'no',
                               'DEBIAN_ENABLED': 'no', 'MSU_ENABLED': 'no', 'NVD_ENABLED': 'no'}
                              for custom_url in json_redhat_custom_urls]
json_redhat_metadata = [
    {'feed': 'redhat', 'custom_feed': custom_url, 'log_system_name': 'JSON Red Hat Enterprise Linux',
     'expected_num_vulnerabilities': vd.REDHAT_NUM_CUSTOM_VULNERABILITIES}
    for custom_url in json_redhat_custom_urls]
json_redhat_ids = [f"JSON_RedHat_{custom_url}" for custom_url in json_redhat_custom_urls]

# Canonical configurations
canonical_custom_urls = custom_urls + [custom_canonical_oval_feed_url + f"{extension}"
                                       for extension in custom_correctly_extensions]
canonical_configurations = [{'REDHAT_ENABLED': 'no', 'CANONICAL_ENABLED': 'yes',
                             'CANONICAL_URL_FEED': custom_url, 'DEBIAN_ENABLED': 'no',
                             'MSU_ENABLED': 'no', 'NVD_ENABLED': 'no'} for custom_url in canonical_custom_urls]
canonical_metadata = [{'feed': 'canonical', 'custom_feed': custom_url, 'log_system_name': 'Ubuntu Bionic',
                       'expected_num_vulnerabilities': vd.CANONICAL_NUM_CUSTOM_VULNERABILITIES}
                      for custom_url in canonical_custom_urls]
canonical_ids = [f"Canonical_{custom_url}" for custom_url in canonical_custom_urls]

# Debian configurations
debian_custom_urls = custom_urls + [custom_debian_oval_feed_url + f"{extension}"
                                    for extension in custom_correctly_extensions]
debian_configurations = [{'REDHAT_ENABLED': 'no', 'CANONICAL_ENABLED': 'no', 'DEBIAN_ENABLED': 'yes',
                          'DEBIAN_URL_FEED': custom_url, 'DEBIAN_JSON_FEED': custom_debian_json_feed_url,
                          'MSU_ENABLED': 'no', 'NVD_ENABLED': 'no'}
                         for custom_url in debian_custom_urls]
debian_metadata = [{'feed': 'debian', 'custom_feed': custom_url, 'log_system_name': 'Debian Buster',
                    'expected_num_vulnerabilities': vd.DEBIAN_NUM_CUSTOM_VULNERABILITIES}
                   for custom_url in debian_custom_urls]
debian_ids = [f"Debian_{custom_url}" for custom_url in debian_custom_urls]

# JSON Debian configurations
json_debian_custom_urls = custom_urls + [custom_debian_json_feed_url]
json_debian_configurations = [{'REDHAT_ENABLED': 'no', 'CANONICAL_ENABLED': 'no', 'DEBIAN_ENABLED': 'yes',
                               'DEBIAN_URL_FEED': custom_debian_oval_feed_url, 'DEBIAN_JSON_FEED': custom_url,
                               'MSU_ENABLED': 'no', 'NVD_ENABLED': 'no'}
                              for custom_url in json_debian_custom_urls]
json_debian_metadata = [{'feed': 'json debian', 'custom_feed': custom_url, 'log_system_name': 'Debian Buster',
                         'expected_num_vulnerabilities': vd.DEBIAN_NUM_CUSTOM_VULNERABILITIES}
                        for custom_url in json_debian_custom_urls]
json_debian_ids = [f"JSON_Debian_{custom_url}" for custom_url in json_debian_custom_urls]

# MSU configurations
msu_custom_urls = custom_urls + [custom_msu_json_feed_url + f"{extension}"
                                 for extension in custom_correctly_extensions]
msu_configurations = [{'REDHAT_ENABLED': 'no', 'CANONICAL_ENABLED': 'no', 'DEBIAN_ENABLED': 'no',
                       'MSU_URL_FEED': custom_file, 'MSU_ENABLED': 'yes', 'NVD_ENABLED': 'no'}
                      for custom_file in msu_custom_urls]
msu_metadata = [{'feed': 'msu', 'custom_feed': custom_file, 'log_system_name': 'Microsoft Security Update',
                 'expected_num_vulnerabilities': 0}
                for custom_file in msu_custom_urls]
msu_ids = [f"MSU_{custom_file}" for custom_file in msu_custom_urls]

# NVD configurations
nvd_custom_urls = custom_urls + [custom_nvd_json_url + f"{extension}"
                                 for extension in custom_correctly_extensions]
nvd_configurations = [{'REDHAT_ENABLED': 'no', 'CANONICAL_ENABLED': 'no', 'DEBIAN_ENABLED': 'no', 'MSU_ENABLED': 'no',
                       'NVD_ENABLED': 'yes', 'NVD_URL_FEED': custom_url} for custom_url in nvd_custom_urls]
nvd_metadata = [{'feed': 'nvd', 'custom_feed': custom_url, 'log_system_name': 'National Vulnerability Database',
                 'expected_num_vulnerabilities': vd.NVD_NUM_CUSTOM_VULNERABILITIES}
                for custom_url in nvd_custom_urls]
nvd_ids = [f"NVD_{custom_url}" for custom_url in nvd_custom_urls]

# Global configuration
parameters = redhat_configurations + json_redhat_configurations + canonical_configurations + debian_configurations \
             + json_debian_configurations + msu_configurations + nvd_configurations
metadata = redhat_metadata + json_redhat_metadata + canonical_metadata + debian_metadata + json_debian_metadata \
           + msu_metadata + nvd_metadata
ids = redhat_ids + json_redhat_ids + canonical_ids + debian_ids + json_debian_ids + msu_ids + nvd_ids

# Configuration data
configurations = load_wazuh_configurations(configurations_path, __name__, params=parameters, metadata=metadata)


@pytest.fixture(scope='module', params=configurations, ids=ids)
def get_configuration(request):
    """Get configurations from the module."""
    return request.param


def test_invalid_type_url_feeds(clean_vuln_tables, get_configuration, configure_environment, restart_modulesd):
    """
    Check that when importing bad feed files, vulnerability report a log parse error otherwise they are imported
    correctly
    """
    custom_feed = get_configuration['metadata']['custom_feed']
    log_system_name = get_configuration['metadata']['log_system_name']

    if get_configuration['metadata']['feed'] == 'nvd':
        pytest.xfail("Add error messages to this case use. Issue: https://github.com/wazuh/wazuh/issues/5210")

    if custom_feed in correctly_url_feeds:
        if '.gz' in custom_feed or '.bz2' in custom_feed:
            vd.check_feed_uncompressed_successfully(
                wazuh_log_monitor=wazuh_log_monitor,
                feed=custom_feed
            )
        vd.check_feed_imported_successfully(
            wazuh_log_monitor=wazuh_log_monitor,
            log_system_name=log_system_name,
            expected_vulnerabilities_number=get_configuration['metadata']['expected_num_vulnerabilities'],
        )

        vd.clean_vuln_and_sys_programs_tables()
    else:
        timeout = vd.VULN_DETECTOR_GLOBAL_TIMEOUT + 10
        expected_vulnerabilities_number = 1 if log_system_name == 'JSON Red Hat Enterprise Linux' else 0
        test_skipped = 1 if get_configuration['metadata']['feed'] == 'msu' and custom_feed == '/tmp/dummy.json' else 0

        if get_configuration['metadata']['feed'] != 'json debian' and not test_skipped:
            vd.check_failure_when_importing_feed(wazuh_log_monitor=wazuh_log_monitor,
                                                 expected_vulnerabilities_number=expected_vulnerabilities_number,
                                                 timeout=timeout
                                                 )
        else:
            if custom_feed != '/tmp/dummy.json':
                vd.check_log_event(wazuh_log_monitor=wazuh_log_monitor,
                                   log_event=f"Couldn't get the Debian feed .*"
                                   )

        if expected_vulnerabilities_number > 0:
            vd.clean_vuln_and_sys_programs_tables()
