'''
copyright: Copyright (C) 2015-2021, Wazuh Inc.

           Created by Wazuh, Inc. <info@wazuh.com>.

           This program is free software; you can redistribute it and/or modify it under the terms of GPLv2

type: integration

brief: Wazuh is able to detect vulnerabilities in the applications installed in agents using the Vulnerability Detector
       module. This software audit is performed through the integration of vulnerability feeds indexed by Redhat,
       Canonical, Debian, Amazon Linux, Alma Linux and NVD Database.

components:
    - vulnerability_detector

suite: scan_types

targets:
    - manager

daemons:
    - wazuh-modulesd

os_platform:
    - linux

os_version:
    - Arch Linux
    - Amazon Linux 2
    - Amazon Linux 1
    - CentOS 8
    - CentOS 7
    - Debian Buster
    - Red Hat 8
    - Ubuntu Focal
    - Ubuntu Bionic

references:
    - https://documentation.wazuh.com/current/user-manual/capabilities/vulnerability-detection/index.html

tags:
    - vulnerability_detector
    - scan_types
'''
import os
import pytest

from wazuh_testing import ALERTS_JSON_PATH
from wazuh_testing.tools.configuration import load_configuration_template, get_test_cases_data
from wazuh_testing.tools.configuration import update_configuration_template
from wazuh_testing.modules.vulnerability_detector import event_monitor as evm
from wazuh_testing.modules import vulnerability_detector as vd


pytestmark = [pytest.mark.server]

# Reference paths
TEST_DATA_PATH = os.path.join(os.path.dirname(os.path.realpath(__file__)), 'data')
CONFIGURATIONS_PATH = os.path.join(TEST_DATA_PATH, 'configuration_template')
TEST_CASES_PATH = os.path.join(TEST_DATA_PATH, 'test_cases')
TEST_FEEDS_PATH = os.path.join(os.path.dirname(os.path.realpath(__file__)), '..', 'data', 'feeds')


# Configuration and cases data
configurations_path = os.path.join(CONFIGURATIONS_PATH, 'configuration_baseline_scan.yaml')
t1_cases_path = os.path.join(TEST_CASES_PATH, 'cases_baseline_scan_start.yaml')
t2_cases_path = os.path.join(TEST_CASES_PATH, 'cases_baseline_scan_alert.yaml')

# Custom feeds path
custom_redhat_oval_feed_path = os.path.join(TEST_FEEDS_PATH, 'redhat', vd.CUSTOM_REDHAT_OVAL_FEED)
custom_redhat_json_feed_path = os.path.join(TEST_FEEDS_PATH, 'redhat', vd.CUSTOM_REDHAT_JSON_FEED)
custom_nvd_json_feed_path = os.path.join(TEST_FEEDS_PATH, 'nvd', vd.CUSTOM_NVD_FEED)

# test_baseline_scan_start configurations
t1_configuration_parameters, t1_configuration_metadata, t1_case_ids = get_test_cases_data(t1_cases_path)
t1_configurations = load_configuration_template(configurations_path, t1_configuration_parameters,
                                                t1_configuration_metadata)

# test_baseline_scan_no_alert configurations
t2_configuration_parameters, t2_configuration_metadata, t2_case_ids = get_test_cases_data(t2_cases_path)
t2_configurations = load_configuration_template(configurations_path, t2_configuration_parameters,
                                                t2_configuration_metadata)

# Set offline custom feeds configuration
t1_configurations = update_configuration_template(
    t1_configurations,  ['CUSTOM_REDHAT_OVAL_FEED', 'CUSTOM_REDHAT_JSON_FEED', 'CUSTOM_NVD_JSON_FEED'],
    [custom_redhat_oval_feed_path, custom_redhat_json_feed_path, custom_nvd_json_feed_path])
t2_configurations = update_configuration_template(
    t2_configurations,  ['CUSTOM_REDHAT_OVAL_FEED', 'CUSTOM_REDHAT_JSON_FEED', 'CUSTOM_NVD_JSON_FEED'],
    [custom_redhat_oval_feed_path, custom_redhat_json_feed_path, custom_nvd_json_feed_path])


@pytest.mark.tier(level=1)
@pytest.mark.parametrize('configuration, metadata', zip(t1_configurations, t1_configuration_metadata), ids=t1_case_ids)
def test_baseline_scan_start(configuration, metadata, set_wazuh_configuration_vdt, truncate_monitored_files,
                             clean_cve_tables_func, prepare_baseline_scan_with_vuln_packages,
                             restart_modulesd_function):
    '''
    description: Check that the baseline scan starts.

    test_phases:
        - Mock an agent with packages.
        - Update sync_info packages data for that mocked agent.
        - Force a baseline scan setting the last full scan DB data.
        - Set a custom Wazuh configuration, with custom feeds for OVAL and NVD.
        - Restart wazuh-modulesd.
        - Check in log that the baseline scan starts.

    wazuh_min_version: 4.3.0

    tier: 1

    parameters:
        - configuration:
            type: dict
            brief: Configuration loaded from `configuration_template`.
        - metadata:
            type: dict
            brief: Test case metadata.
        - set_wazuh_configuration_vdt:
            type: fixture
            brief: Set wazuh configuration.
        - truncate_monitored_files:
            type: fixture
            brief: Truncate all the log files and json alerts files before and after the test execution.
        - clean_cve_tables_func:
            type: fixture
            brief: Clean all CVE tables.
        - prepare_baseline_scan_with_vuln_packages:
            type: fixture
            brief: Setup the initial test state.
        - restart_modulesd_function:
            type: fixture
            brief: Restart wazuh-modulesd daemon before starting a test, and stop it after finishing.

    assertions:
        - Check that the baseline scan log appears.

    input_description:
        - The `configuration_baseline_scan.yaml` file provides the module configuration for this test.
        - The `cases_baseline_scan_start` file provides the test cases.

    expected_output:
        - f"A baseline scan will be run on agent '{agent_id}'"
    '''
    agent_id = prepare_baseline_scan_with_vuln_packages

    # Check (in log) that the baseline scan has been launched
    evm.check_baseline_scan_start_log(agent_id=agent_id, timeout=vd.T_10)


@pytest.mark.tier(level=1)
@pytest.mark.parametrize('configuration, metadata', zip(t2_configurations, t2_configuration_metadata), ids=t2_case_ids)
def test_baseline_scan_alert(configuration, metadata, set_wazuh_configuration_vdt, truncate_monitored_files,
                             clean_cve_tables_func, prepare_baseline_scan_with_vuln_packages,
                             restart_modulesd_function):
    '''
    description: Check that the baseline scan detects vulnerabilities, and reports them as alerts.

    test_phases:
        - Mock an agent with vulnerable packages.
        - Update sync_info packages data for that mocked agent.
        - Force a baseline scan setting the last full scan DB data.
        - Set a custom Wazuh configuration, with custom feeds for OVAL and NVD.
        - Restart wazuh-modulesd.
        - Wait for a baseline scan.
        - Check that the vulnerability has been detected.
        - Check that vulnerability alert has been generated.

    wazuh_min_version: 4.3.0

    tier: 1

    parameters:
        - configuration:
            type: dict
            brief: Configuration loaded from `configuration_template`.
        - metadata:
            type: dict
            brief: Test case metadata.
        - set_wazuh_configuration_vdt:
            type: fixture
            brief: Set wazuh configuration.
        - truncate_monitored_files:
            type: fixture
            brief: Truncate all the log files and json alerts files before and after the test execution.
        - clean_cve_tables_func:
            type: fixture
            brief: Clean all CVE tables.
        - prepare_baseline_scan_with_vuln_packages:
            type: fixture
            brief: Setup the initial test state.
        - restart_modulesd_function:
            type: fixture
            brief: Restart wazuh-modulesd daemon before starting a test, and stop it after finishing.

    assertions:
        - Check that the vulnerability is detected.
        - Check that the vulnerability alert is generated.

    input_description:
        - The `configuration_baseline_scan.yaml` file provides the module configuration for this test.
        - The `cases_baseline_scan_alert` file provides the test cases.

    expected_output:
        - f"The '{package}' package .* from agent '{agent_id}' is vulnerable to '{cve}'"
        - f"NOT .*"agent":."id":"{agent_id}".*{cve} affects {package}"
    '''
    agent_id = prepare_baseline_scan_with_vuln_packages

    # Check (in log) that the baseline scan has been launched
    evm.check_baseline_scan_start_log(agent_id=agent_id, timeout=vd.T_10)

    # Check that the vulnerability from first package is detected
    evm.check_vulnerability_affects_log(agent_id=agent_id, package=vd.VULNERABLE_PACKAGES[0]['name'],
                                        cve=vd.VULNERABLE_PACKAGES[0]['cveid'])

    # Check that there is vulnerability alert (baseline scan generate alerts)
    evm.check_vulnerability_affects_alert(agent_id=agent_id, package=vd.VULNERABLE_PACKAGES[0]['name'],
                                          cve=vd.VULNERABLE_PACKAGES[0]['cveid'])
