# Test scan providers and NVD feed

These tests will mock RedHat, Canonical, and Debian, and insert custom vulnerabilities and vulnerable packages to check if Vulnerability Detector generates the vulnerability alerts from NVD and providers feed.

## General info

|Tier | Number of tests | Time spent| Test file |
|:--:|:--:|:--:|:--:|
| 0 | 11 | 0:04:22 | [test_scan_providers_and_nvd_feed.py](../../test_scan_results/test_scan_providers_and_nvd_feed.py)|

## Test logic

For each of these systems:

```
Red Hat --> RHEL8, RHEL7, RHEL6, RHEL5
Debian --> BUSTER, STRETCH, JESSIE, WHEEZY
Ubuntu --> BIONIC, XENIAL, TRUSTY
```

The following actions are done:
- Clean NVD, `vulnerabilities`, and `sys_programs tables`.
- Mock the system.
- Insert **simulated** provider vulnerabilities in the `vulnerabilities` table, simulating having imported a feed from a
  provider.
- Insert **simulated** NVD [vulnerable packages](../../test_scan_results/data/vulnerabilities.json) and provider
  **simulated** [vulnerable packages](../../test_scan_results/data/vulnerabilities.json)
- Import **simulated** NVD vulnerabilities from [custom NVD feed](../../test_scan_results/data/custom_nvd_feed.json).
- Check these events in `ossec.log`:

  - For each provider, check:

    ```
    The '{package}' package .* from agent .* is vulnerable to '{cve}'
    ```

  - For each NVD vulnerability (except RedHat systems):

    ```
    The '{package}' package .* from agent .* is vulnerable to '{cve}'
    ```

  - Finally, check the number of alerts that have been reported by NVD and the provider.

    ```
    A total of '{provider_vulnerabilities_number}' vulnerabilities have been reported for agent '.*' " +
            "thanks to the 'vendor' feed.
    A total of '{nvd_vulnerabilities_number}' vulnerabilities have been reported for agent '.*' " +
            "thanks to the 'NVD' feed.
    ```

## Checks

- [x] As many NVD and provider alerts are generated as there are vulnerabilities.
- [x] There is 0 NVD vulnerability alerts for Red Hat provider.
- [x] The expected number of reported alerts is generated by NVD and provider.

## Observed behaviour

The expected behavior is carried out.

## Execution result

```
========================================= test session starts ==========================================
platform linux -- Python 3.7.3, pytest-5.4.2, py-1.8.1, pluggy-0.13.1
rootdir: /root/wazuh-qa/tests/integration, inifile: pytest.ini
plugins: html-2.0.1, metadata-1.9.0, testinfra-5.0.0
collected 11 items

test_vulnerability_detector/test_scan_results/test_scan_providers_and_nvd_feed.py ...........    [100%]

==================================== 11 passed in 262.79s (0:04:22) ====================================
```
