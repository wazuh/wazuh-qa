# Test scan NVD feed

Tests that are based on mocking Red Hat, Canonical Debian and Windows systems, and inserting custom vulnerabilities and
vulnerable packages to see if vulnerability detector generates the vulnerability alerts from NVD feed.

## General info

|Tier | Number of tests | Time spent| Test file |
|:--:|:--:|:--:|:--:|
| 0 | 12 | 0:04:24 | [test_scan_nvd_feed.py](../../test_scan_results/test_scan_nvd_feed.py)|

## Test logic

For each of the following systems:

```
Red Hat --> RHEL8, RHEL7, RHEL6, RHEL5
Debian --> BUSTER, STRETCH, JESSIE, WHEEZY
Ubuntu --> BIONIC, XENIAL, TRUSTY
Windows --> WINDOWS10
```

the following is done:

- Clean NVD, `vulnerabilities` and `sys_programs tables`.
- Mock system.
- If mocked system is *Windows*:
  - vd.insert_osinfo()
  - vd.insert_hotfix()
- Insert a dummy vulnerability in `vulnerabilities` table, simulating having imported a feed from a provider.
- Insert NVD **simulated** [vulnerable packages](../../test_scan_results/data/vulnerabilities.json)
- Import NVD **simulated** vulnerabilities from [custom NVD feed](../../test_scan_results/data/custom_nvd_feed.json).
- Check the following events in `ossec.log`:

  - If *Windows*:

    ```
    Agent '000' is vulnerable to '{cve}'. Condition: '{patch} patch is not installed.'
    ```

  - If *Red Hat*, then the alert is not checked, because it is disabled

  - For other systems:

    ```
    The '{package}' package .* from agent .* is vulnerable to '{cve}'
    ```

  - Finally, for all systems it is checked

    ```
    The NVD found a total of '{vulnerabilities_number}' potential vulnerabilities for agent .*
    ```

## Checks

- [x] As many NVD alerts are generated as there are vulnerabilities.
- [x] There is 0 NVD vulnerability alerts for Red Hat provider.
- [x] The alerts come exactly from NVD.

## Observed behaviour

The expected behavior is carried out.

## Execution result

```
========================================= test session starts ==========================================
platform linux -- Python 3.7.3, pytest-5.4.2, py-1.8.1, pluggy-0.13.1
rootdir: /root/wazuh-qa/tests/integration, inifile: pytest.ini
plugins: html-2.0.1, metadata-1.9.0, testinfra-5.0.0
collected 12 items

test_vulnerability_detector/test_scan_results/test_scan_nvd_feed.py ............                 [100%]

==================================== 12 passed in 264.82s (0:04:24) ====================================
```
