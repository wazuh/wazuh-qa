# Copyright (C) 2015-2021, Wazuh Inc.
# Created by Wazuh, Inc. <info@wazuh.com>.
# This program is free software; you can redistribute it and/or modify it under the terms of GPLv2
import os
import time
import re
import math
import pytest
import wazuh_testing.vulnerability_detector as vd

from datetime import datetime
from wazuh_testing.tools import LOG_FILE_PATH
from wazuh_testing.tools.configuration import load_wazuh_configurations, check_apply_test
from wazuh_testing.tools.monitoring import FileMonitor
from wazuh_testing.tools.time import time_to_seconds

# Marks
pytestmark = [pytest.mark.server, pytest.mark.tier(level=0)]

# variables
test_data_path = os.path.join(os.path.dirname(os.path.realpath(__file__)), 'data')
test_feed_path = os.path.join(os.path.dirname(os.path.realpath(__file__)), '..', 'data', 'feeds')
configurations_path = os.path.join(test_data_path, 'wazuh_retry_interval.yaml')
wazuh_log_monitor = FileMonitor(LOG_FILE_PATH)
retry_interval_values = [25, 30, 35]
retry_interval_units = ['s']
parameters = []
metadata = []
ids = []

# Offline feeds
rhel_oval_feed_path = os.path.join(test_feed_path, vd.CUSTOM_REDHAT_OVAL_FEED)
rhel_json_feed_path = os.path.join(test_feed_path, vd.CUSTOM_REDHAT_JSON_FEED)
nvd_json_feed_path = os.path.join(test_feed_path, vd.CUSTOM_NVD_FEED)

for value in retry_interval_values:
    for unit in retry_interval_units:
        parameters.append({'RETRY_INTERVAL': f"{value}{unit}",
                           'RHEL_FEED_PATH': rhel_oval_feed_path,
                           'RHEL_JSON_FEED_PATH': rhel_json_feed_path,
                           'NVD_JSON_FEED_PATH': nvd_json_feed_path})
        metadata.append({'retry_interval': f"{value}{unit}"})
        ids.append(f"{value}{unit}")

# Configuration data
configurations = load_wazuh_configurations(configurations_path, __name__, params=parameters, metadata=metadata)

# fixtures
@pytest.fixture(scope='module', params=configurations, ids=ids)
def get_configuration(request):
    """Get configurations from the module."""
    return request.param


@pytest.fixture(scope='function')
def mock_system(mock_agent):
    """
    It mocks an agent with syscollector packages in a not synced state.
    """
    vd.insert_osinfo(agent=mock_agent)

    # Force not synced state for syscollector packages
    vd.update_sync_info(agent=mock_agent, last_attempt=0, last_completion=0)

    yield mock_agent

    vd.clean_vd_tables(mock_agent)


def test_retry_interval(get_configuration, configure_environment, restart_modulesd, mock_system):
    """Check if the Vulnerability Detector module retries the scan after a failure attempt when the value set in
    retry_interval expires.

    For this purpose, the manager is configured to use custom feeds that include a vulnerability associated
    with a test package. This package is added to the database of the mocked agent and, after the enrollment
    of the agent, the vulnerability detector must attempt to launch the first scan on it.

    As the syscollector database is not synchronized (last_completion attribute in sync_info table does not match
    with the last_attemp attribute) the scan on the agent is skipped.

    After the syscollector database is synchronized (last_completion attribute in sync_info table match
    with the last_attemp attribute) the scan on the agent is performed.

    Args:
        get_configuration (fixture): Get configurations from the module.
        configure_environment (fixture): Configure a custom environment for testing.
        restart_modulesd (fixture): Reset wazuh_modulesd daemon, truncates ossec.log file and starts a new monitor.
        mock_system (fixture): Add a mocked agent to the manager for testing.
    """
    check_apply_test({'retry_interval'}, get_configuration['tags'])
    agent_id = mock_system
    retry_interval = time_to_seconds(get_configuration['metadata']['retry_interval'])

    def get_timestamp(log_line):
        callback_log_line = vd.make_vuln_callback(pattern=log_line, prefix='.*')
        wazuh_log_monitor.start(timeout=vd.VULN_DETECTOR_SCAN_TIMEOUT,
                                callback=callback_log_line,
                                error_message='Log line not found.')

        regex = f"(\\d{{4}}/\\d{{2}}/\\d{{2}}\\s\\d{{2}}:\\d{{2}}:\\d{{2}}).*{log_line}"
        with open(LOG_FILE_PATH) as file:
            lines = file.readlines()
            for line in lines:
                exist = re.search(regex, line)
                if exist:
                    return datetime.strptime(exist.group(1), '%Y/%m/%d %H:%M:%S')

    first_scan_fail_time = get_timestamp('Going to sleep \\d+ seconds before retrying pending agents')

    # Force syscollector database synchronization.
    vd.update_sync_info(agent=agent_id)

    scan_success_time = get_timestamp(f"Analyzing OVAL vulnerabilities for agent '{agent_id}'")

    time_between_scan_retries = (scan_success_time - first_scan_fail_time).total_seconds()

    assert math.trunc(time_between_scan_retries) >= retry_interval
