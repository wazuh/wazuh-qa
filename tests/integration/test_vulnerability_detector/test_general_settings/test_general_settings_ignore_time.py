# Copyright (C) 2015-2020, Wazuh Inc.
# Created by Wazuh, Inc. <info@wazuh.com>.
# This program is free software; you can redistribute it and/or modify it under the terms of GPLv2

import os
import pytest
from time import sleep
from datetime import timedelta

from wazuh_testing.tools import LOG_FILE_PATH
from wazuh_testing.fim import check_time_travel
from wazuh_testing.tools.time import time_to_seconds
from wazuh_testing.tools.monitoring import FileMonitor
from wazuh_testing.tools.services import control_service
from wazuh_testing.tools.configuration import load_wazuh_configurations
from wazuh_testing.vulnerability_detector import DEFAULT_PACKAGE_NAME, DEFAULT_VULNERABILITY_ID, \
                                                 update_last_scan, modify_system, clean_vd_tables, \
                                                 insert_vulnerability, insert_package, make_vuln_callback, \
                                                 NVD_FEED


# Marks
pytestmark = pytest.mark.tier(level=0)

# variables
test_path = os.path.dirname(os.path.realpath(__file__))
test_data_path = os.path.join(test_path, 'data')
nvd_feed_path = os.path.join(os.path.dirname(test_path), 'test_scan_results', 'data', NVD_FEED)
configurations_path = os.path.join(test_data_path, 'wazuh_ignore_time.yaml')

wazuh_log_monitor = FileMonitor(LOG_FILE_PATH)

callback_string_vulnerability = f"'{DEFAULT_PACKAGE_NAME}'.+is vulnerable to '{DEFAULT_VULNERABILITY_ID}'"

parameters = [{'IGNORE_TIME': '3600s', 'INTERVAL': '5s', 'NVD_FEED_PATH': nvd_feed_path},
              {'IGNORE_TIME': '60m', 'INTERVAL': '5s', 'NVD_FEED_PATH': nvd_feed_path},
              {'IGNORE_TIME': '1h', 'INTERVAL': '5s', 'NVD_FEED_PATH': nvd_feed_path}]
metadata= [{'ignore_time': '3600s', 'timeout': 30, 'jumps': 2, 'interval': '5s'},
           {'ignore_time': '60m', 'timeout': 30, 'jumps': 2, 'interval': '5s'},
           {'ignore_time': '1h', 'timeout': 30, 'jumps': 2, 'interval': '5s'}]

# Configuration data
configurations = load_wazuh_configurations(configurations_path, __name__, params=parameters, metadata=metadata)

# fixtures
@pytest.fixture(scope='module', params=configurations)
def get_configuration(request):
    """Get configurations from the module."""
    return request.param


#functions
def generate_default_alert():
    """
    Generate an alert with the default values
    """
    control_service('stop', daemon='wazuh-db')
    sleep(5)
    clean_vd_tables()
    insert_package()
    insert_vulnerability()
    update_last_scan()
    modify_system()
    control_service('start', daemon='wazuh-db')


def test_ignore_time(get_configuration, configure_environment, restart_modulesd,
                     tags_to_apply = 'test_ignore_time',
                     custom_callback_vulnerability = make_vuln_callback(callback_string_vulnerability)):
    """
    Check if an alert is not fired during the ingnore time  interval
    """
    generate_default_alert()
    ignore_time = get_configuration['metadata']['ignore_time']
    jumps = get_configuration['metadata']['jumps']
    seconds_to_travel = time_to_seconds(ignore_time)/jumps

    # Check for initial alert
    wazuh_log_monitor.start(timeout=get_configuration['metadata']['timeout'],
                            callback=custom_callback_vulnerability,
                            error_message='Alert did not appear at the start of the test')

    # Check if alert does not appear during ignore time
    for _ in range(1, jumps):
        check_time_travel(time_travel=True, interval=timedelta(seconds=seconds_to_travel))
        with pytest.raises(TimeoutError):
            wazuh_log_monitor.start(timeout=get_configuration['metadata']['timeout'],
                                    callback=custom_callback_vulnerability)
            raise AttributeError('Alert appeared before ignore_time was finished')

    # Travel to the time set in ignore time
    check_time_travel(time_travel=True, interval=timedelta(seconds=seconds_to_travel))

    # Check for final alert
    wazuh_log_monitor.start(timeout=get_configuration['metadata']['timeout'],
                            callback=custom_callback_vulnerability,
                            error_message='Alert did not appear at the end of the test')
