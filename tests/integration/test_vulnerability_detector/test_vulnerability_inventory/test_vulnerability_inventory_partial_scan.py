'''
copyright: Copyright (C) 2015-2021, Wazuh Inc.

           Created by Wazuh, Inc. <info@wazuh.com>.

           This program is free software; you can redistribute it and/or modify it under the terms of GPLv2

type: integration

brief: Wazuh is able to detect vulnerabilities in the applications installed in agents using the Vulnerability Detector
       module. This software audit is performed through the integration of vulnerability feeds indexed by Redhat,
       Canonical, Debian, Amazon Linux, Alma Linux and NVD Database.

components:
    - vulnerability_detector

suite: vulnerability_inventory

targets:
    - manager

daemons:
    - wazuh-modulesd

os_platform:
    - linux

os_version:
    - Arch Linux
    - Amazon Linux 2
    - Amazon Linux 1
    - CentOS 8
    - CentOS 7
    - Debian Buster
    - Red Hat 8
    - Ubuntu Focal
    - Ubuntu Bionic

references:
    - https://documentation.wazuh.com/current/user-manual/capabilities/vulnerability-detection/index.html
'''
import os
import pytest

from wazuh_testing import ALERTS_JSON_PATH
from wazuh_testing.tools.configuration import load_configuration_template, get_test_cases_data
from wazuh_testing.tools.configuration import update_configuration_template
from wazuh_testing.db_interface import agent_db
from wazuh_testing.modules.vulnerability_detector import event_monitor as evm
from wazuh_testing.modules import vulnerability_detector as vd


pytestmark = [pytest.mark.server]

# Reference paths
TEST_DATA_PATH = os.path.join(os.path.dirname(os.path.realpath(__file__)), 'data')
CONFIGURATIONS_PATH = os.path.join(TEST_DATA_PATH, 'configuration_template')
TEST_CASES_PATH = os.path.join(TEST_DATA_PATH, 'test_cases')
TEST_FEEDS_PATH = os.path.join(os.path.dirname(os.path.realpath(__file__)), '..', 'data', 'feeds')

# Configuration and cases data
configurations_path = os.path.join(CONFIGURATIONS_PATH, 'configuration_vulnerability_inventory_partial_scan.yaml')
t1_cases_path = os.path.join(TEST_CASES_PATH, 'cases_vulnerability_inserted_partial_scan.yaml')
t2_cases_path = os.path.join(TEST_CASES_PATH, 'cases_vulnerability_removed_partial_scan.yaml')

# Custom feeds path
custom_redhat_oval_feed_path = os.path.join(TEST_FEEDS_PATH, 'redhat', vd.CUSTOM_REDHAT_OVAL_FEED)
custom_redhat_json_feed_path = os.path.join(TEST_FEEDS_PATH, 'redhat', vd.CUSTOM_REDHAT_JSON_FEED)
custom_nvd_json_feed_path = os.path.join(TEST_FEEDS_PATH, 'nvd', vd.CUSTOM_NVD_FEED)

# test_vulnerability_inserted_partial_scan configurations
t1_configuration_parameters, t1_configuration_metadata, t1_case_ids = get_test_cases_data(t1_cases_path)
t1_configurations = load_configuration_template(configurations_path, t1_configuration_parameters,
                                                t1_configuration_metadata)

# test_vulnerability_removed_partial_scan configurations
t2_configuration_parameters, t2_configuration_metadata, t2_case_ids = get_test_cases_data(t2_cases_path)
t2_configurations = load_configuration_template(configurations_path, t2_configuration_parameters,
                                                t2_configuration_metadata)

# Set offline custom feeds configuration
t1_configurations = update_configuration_template(
    t1_configurations,  ['CUSTOM_REDHAT_OVAL_FEED', 'CUSTOM_REDHAT_JSON_FEED', 'CUSTOM_NVD_JSON_FEED'],
    [custom_redhat_oval_feed_path, custom_redhat_json_feed_path, custom_nvd_json_feed_path])
t2_configurations = update_configuration_template(
    t2_configurations,  ['CUSTOM_REDHAT_OVAL_FEED', 'CUSTOM_REDHAT_JSON_FEED', 'CUSTOM_NVD_JSON_FEED'],
    [custom_redhat_oval_feed_path, custom_redhat_json_feed_path, custom_nvd_json_feed_path])


@pytest.mark.tier(level=1)
@pytest.mark.parametrize('configuration, metadata', zip(t1_configurations, t1_configuration_metadata), ids=t1_case_ids)
def test_vulnerability_inserted_partial_scan(configuration, metadata, set_wazuh_configuration_vdt,
                                             truncate_monitored_files, clean_cve_tables_func,
                                             prepare_partial_scan_with_vuln_packages, restart_modulesd_function):
    '''
    description: Check that the partial scan inserts the detected vulnerabilities.

    test_phases:
        - Mock an agent with vulnerable packages.
        - Update sync_info packages data for that mocked agent.
        - Force a partial scan setting the last full scan DB data.
        - Set a custom Wazuh configuration, with custom feeds for OVAL and NVD.
        - Restart wazuh-modulesd.
        - Check in the log that the partial scan starts.
        - Check in the log that the vulnerabilities have been detected.
        - Check in the agent database that the vulnerability has been inserted in the vuln_cves table (inventory).

    wazuh_min_version: 4.3.0

    tier: 1

    parameters:
        - configuration:
            type: dict
            brief: Configuration loaded from `configuration_template`.
        - metadata:
            type: dict
            brief: Test case metadata.
        - set_wazuh_configuration_vdt:
            type: fixture
            brief: Set wazuh configuration.
        - truncate_monitored_files:
            type: fixture
            brief: Truncate all the log files and json alerts files before and after the test execution.
        - clean_cve_tables_func:
            type: fixture
            brief: Clean all CVE tables.
        - prepare_partial_scan_with_vuln_packages:
            type: fixture
            brief: Setup the initial test state.
        - restart_modulesd_function:
            type: fixture
            brief: Restart wazuh-modulesd daemon before starting a test, and stop it after finishing.

    assertions:
        - Check that the partial scan log appears.
        - Check that the vulnerabilities are detected.
        - Check that vulnerabilities have been inserted in the vuln_cves inventory.

    input_description:
        - The `configuration_partial_vulnerability_inventory.yaml` file provides the module configuration for this test.
        - The `cases_partial_vulnerability_inserted` file provides the test cases.
    '''
    agent_id = prepare_partial_scan_with_vuln_packages

    # Check (in log) that the partial scan has been launched
    evm.check_partial_scan_start_log(agent_id=agent_id, timeout=vd.T_10)

    # Check the vulnerability detection
    for vulnerable_package in vd.VULNERABLE_PACKAGES:
        evm.check_vulnerability_affects_log(agent_id=agent_id, package=vulnerable_package['name'],
                                            cve=vulnerable_package['cveid'])

    # Check that the vulnerability has been inserted in the agent vulnerability inventory
    assert len(agent_db.get_vulnerability_inventory_data(agent_id=agent_id, status='VALID')) == \
        len(vd.VULNERABLE_PACKAGES)


@pytest.mark.tier(level=1)
@pytest.mark.parametrize('configuration, metadata', zip(t2_configurations, t2_configuration_metadata), ids=t2_case_ids)
def test_vulnerability_removed_partial_scan(configuration, metadata, set_wazuh_configuration_vdt,
                                            truncate_monitored_files, clean_cve_tables_func,
                                            prepare_partial_scan_with_obsolete_vulnerabilities,
                                            restart_modulesd_function):
    '''
    description: Check that the partial scan removes the obsolete vulnerabilities from the inventory.

    test_phases:
        - Mock an agent with OBSOLETE vulnerabilities in the vuln_cves inventory.
        - Update sync_info packages data for that mocked agent.
        - Force a partial scan setting the last full scan DB data.
        - Set a custom Wazuh configuration, with custom feeds for OVAL and NVD.
        - Restart wazuh-modulesd.
        - Check in the log that the partial scan starts.
        - Check in the log that the partial scan ends.
        - Check that the OBSOLETE vulnerabilities of the vuln_cves inventory have been removed.

    wazuh_min_version: 4.3.0

    tier: 1

    parameters:
        - configuration:
            type: dict
            brief: Configuration loaded from `configuration_template`.
        - metadata:
            type: dict
            brief: Test case metadata.
        - set_wazuh_configuration_vdt:
            type: fixture
            brief: Set wazuh configuration.
        - truncate_monitored_files:
            type: fixture
            brief: Truncate all the log files and json alerts files before and after the test execution.
        - clean_cve_tables_func:
            type: fixture
            brief: Clean all CVE tables.
        - prepare_partial_scan:
            type: fixture
            brief: Setup the initial test state.
        - restart_modulesd_function:
            type: fixture
            brief: Restart wazuh-modulesd daemon before starting a test, and stop it after finishing.

    assertions:
        - Check that the partial scan log appears.
        - Check that the partial scan ends.
        - Check that the OBSOLETE vulnerabilities of the vuln_cves inventory have been removed.

    input_description:
        - The `configuration_partial_vulnerability_inventory.yaml` file provides the module configuration for this test.
        - The `cases_partial_vulnerability_removed` file provides the test cases.
    '''
    agent_id = prepare_partial_scan_with_obsolete_vulnerabilities

    # Check that the vulnerabilities are in the inventory as OBSOLETE
    assert len(agent_db.get_vulnerability_inventory_data(agent_id=agent_id, status='OBSOLETE')) == \
        len(vd.VULNERABLE_PACKAGES), 'The number of vulnerabilities in vuln_cves is not the expected one'

    # Check (in log) that the partial scan has been launched
    evm.check_partial_scan_start_log(agent_id=agent_id, timeout=vd.T_10)

    # Wait until vulnerability scan finishes
    evm.check_vulnerability_scan_finished(timeout=vd.T_10)

    # Check that the OBSOLETE vulnerabilities have been removed
    assert len(agent_db.get_vulnerability_inventory_data(agent_id=agent_id)) == 0, \
        'The vulnerabilities inventory data has not been removed'
