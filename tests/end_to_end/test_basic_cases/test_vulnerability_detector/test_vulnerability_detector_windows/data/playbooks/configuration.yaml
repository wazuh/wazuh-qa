- name: Configure Windows agent environment
  hosts: windows-agent
  tasks:

    - name: Create temp folder
      win_file:
        path: C:\temp
        state: directory

    - name: Copy ossec.conf
      ansible.windows.win_copy:
        src: C:\Program Files (x86)\ossec-agent\ossec.conf
        dest: C:\temp
        remote_src: true

    - name: Enable the agent module to collect installed packages (Windows)
      include_role:
        name: manage_wazuh_configurations
        tasks_from: write_wazuh_config.yaml
      vars:
        config_block: |
          Add-Content 'C:\Program Files (x86)\ossec-agent\ossec.conf' "`n<ossec_config>"
          Add-Content 'C:\Program Files (x86)\ossec-agent\ossec.conf' "`n<wodle name='syscollector'>"
          Add-Content 'C:\Program Files (x86)\ossec-agent\ossec.conf' "`n<disabled>no</disabled>"
          Add-Content 'C:\Program Files (x86)\ossec-agent\ossec.conf' "`n<interval>10s</interval>"
          Add-Content 'C:\Program Files (x86)\ossec-agent\ossec.conf' "`n<os>yes</os>"
          Add-Content 'C:\Program Files (x86)\ossec-agent\ossec.conf' "`n<packages>yes</packages>"
          Add-Content 'C:\Program Files (x86)\ossec-agent\ossec.conf' "`n<hotfixes>yes</hotfixes>"
          Add-Content 'C:\Program Files (x86)\ossec-agent\ossec.conf' "`n</wodle>"
          Add-Content 'C:\Program Files (x86)\ossec-agent\ossec.conf' "`n</ossec_config>"
        os: windows

    - name: Restart wazuh-agent
      include_role:
        name: manage_wazuh
        tasks_from: restart_wazuh.yaml
      vars:
        os: windows

- name: Configure manager environment
  hosts: manager
  tasks:

    - name: Truncate file ossec.log
      shell: echo "" > /var/ossec/logs/ossec.log
      become: true

    - name: Enable vulnerability detector module
      include_role:
        name: manage_wazuh_configurations
        tasks_from: write_wazuh_config.yaml
      vars:
        config_block: |
          <vulnerability-detector>
          <enabled>yes</enabled>
          <interval>10s</interval>
          <min_full_scan_interval>10s</min_full_scan_interval>
          <run_on_start>yes</run_on_start>

          <!-- Windows OS vulnerabilities -->
          <provider name="msu">
          <enabled>yes</enabled>
          <update_interval>1h</update_interval>
          </provider>

          <!-- Aggregate vulnerabilities -->
          <provider name="nvd">
          <enabled>yes</enabled>
          <update_interval>1h</update_interval>
          </provider>
          </vulnerability-detector>
        os: linux

    - name: Restart wazuh-manager
      include_role:
        name: manage_wazuh
        tasks_from: restart_wazuh.yaml
      vars:
        os: linux

    - name: Wait until the feeds were downloaded and the first scan was completed
      become: true
      wait_for:
        path: /var/ossec/logs/ossec.log
        search_regex: Vulnerability scan finished.
