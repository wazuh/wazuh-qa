- name: Configure Ubuntu agent environment
  hosts: ubuntu-agent
  tasks:

    - name: Enable the agent module to collect installed packages
      include_role:
        name: manage_wazuh_configurations
        tasks_from: write_wazuh_config.yaml
      vars:
        config_block: |
          <wodle name="syscollector">
          <disabled>no</disabled>
          <interval>10s</interval>
          <os>yes</os>
          <packages>yes</packages>
          </wodle>
        os: linux

    - name: Restart wazuh-agent
      include_role:
        name: manage_wazuh
        tasks_from: restart_wazuh.yaml
      vars:
        os: linux

- name: Configure manager environment
  hosts: managers
  tasks:

    - name: Truncate ossec.log
      shell: echo "" > /var/ossec/logs/ossec.log
      become: true

    - name: Enabled vulnerability detector module
      include_role:
        name: manage_wazuh_configurations
        tasks_from: write_wazuh_config.yaml
      vars:
        config_block: |
          <vulnerability-detector>
          <enabled>yes</enabled>
          <interval>10s</interval>
          <min_full_scan_interval>10s</min_full_scan_interval>
          <run_on_start>yes</run_on_start>

          <!-- Ubuntu OS vulnerabilities -->
          <provider name="canonical">
          <enabled>yes</enabled>
          <os>focal</os>
          <update_interval>1h</update_interval>
          </provider>

          <!-- Aggregate vulnerabilities -->
          <provider name="nvd">
          <enabled>yes</enabled>
          <update_from_year>2021</update_from_year>
          <update_interval>1h</update_interval>
          </provider>
          </vulnerability-detector>
        os: linux

    - name: Restart wazuh-manager
      include_role:
        name: manage_wazuh
        tasks_from: restart_wazuh.yaml
      vars:
        os: linux

    - name: Wait until the feeds were downloaded and the first scan was completed
      become: true
      wait_for:
        path: /var/ossec/logs/ossec.log
        search_regex: Vulnerability scan finished.
