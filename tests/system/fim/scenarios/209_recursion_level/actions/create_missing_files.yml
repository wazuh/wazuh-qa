---
- block:
  - name: Create above the recursion limit level files on agents | Linux
    script: "../../../common_tasks/generate_files.py -c {{ files_missing_config_linux_destination_path }} -o {{ files_added_output_path }}-missing {{ create_script_extra_params }}"
    args:
      executable: "python3.6"
      chdir: "{{ agents_linux_output_path }}"

  - name: Copy list of above the recursion limit level files from Agents to Ansible Controller host | Linux
    fetch:
      src: "{{ agents_linux_output_path }}/{{ files_added_output_path }}-missing"
      dest: "agents_outputs/{{ event }}/missing/{{ files_added_output_path }}-{{ inventory_hostname }}"
      flat: yes
  become: yes
  when:
    - inventory_hostname in groups['linuxagents']

- block:
  - name: Create above the recursion limit level files on agents | Windows
    script: "../../../common_tasks/generate_files.py -c {{ files_missing_config_windows_destination_path }} -o {{ files_added_output_path }}-missing {{ create_script_extra_params }}"
    args:
      executable: "python"
      chdir: "{{ agents_windows_output_path }}"

  - name: Copy list of above the recursion limit level files from Agents to Ansible Controller host | Windows
    fetch:
      src: "{{ agents_windows_output_path }}/{{ files_added_output_path }}-missing"
      dest: "agents_outputs/{{ event }}/missing/{{ files_added_output_path }}-{{ inventory_hostname }}"
      flat: yes

  when:
  - inventory_hostname in groups['windowsagents']

- name: Copy the output files from Ansible Controller to the Managers
  become: true
  synchronize:
    src: "agents_outputs/{{ event }}/missing/"
    dest: "{{ agents_results_manager_path }}/{{ event }}/missing/"
    recursive: yes
    delete: yes
  when:
    - inventory_hostname in groups['masters']
