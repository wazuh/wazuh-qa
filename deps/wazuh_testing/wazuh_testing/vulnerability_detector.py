# Copyright (C) 2015-2020, Wazuh Inc.
# Created by Wazuh, Inc. <info@wazuh.com>.
# This program is free software; you can redistribute it and/or modify it under the terms of GPLv2

import re
from collections import namedtuple

UpdateFromYearResult = namedtuple('UpdateFromYearResult', 'result actual_provider actual_update_from')

nvd_check_feed_download_regex = r'.* wazuh-modulesd.*Downloading.*nvd\.nist\.gov\/feeds.*-(.*)\.(json|meta).*'

vulnerability_detector_prefix = r'.*wazuh-modulesd:vulnerability-detector:\s+INFO:\s+\(\d+\):\s+'


def callback_detect_vulnerability_scan_started(line):
    msg = r'.*wazuh-modulesd:vulnerability-detector.* INFO:.*Starting vulnerability scanning'
    match = re.match(msg, line)

    return match is not None


def callback_detect_vulnerability_scan_finished(line):
    msg = r'.*wazuh-modulesd:vulnerability-detector.* INFO:.*Vulnerability scanning finished'
    match = re.match(msg, line)
    return match is not None


def callback_detect_vulnerability_scan_sleeping(line):
    msg = r'.*wazuh-modulesd:vulnerability-detector.* Sleeping for (.*)...'
    match = re.match(msg, line)

    return match.group(1) if match is not None else ""


def callback_detect_update_from_year_result(line):
    invalid_year_msg = r'.*wazuh-modulesd.*wmodules-vuln-detector.*ERROR: Invalid content for \'update_from_year\' option at module \'vulnerability-detector\''
    invalid_year_match = re.match(invalid_year_msg, line)

    if invalid_year_match is not None:
        return UpdateFromYearResult("invalid_year", None, None)

    provider_added_msg = r'.*wazuh-modulesd.*Added (.*) feed.*Update since: (.*)\.'
    provider_added_match = re.match(provider_added_msg, line)

    if provider_added_match is not None:
        return UpdateFromYearResult("provider_added", provider_added_match.group(1), int(provider_added_match.group(2)))

    return None


def callback_download_redhat_feed_from_year(line):
    download_redhat_from_msg = r'.*wazuh-modulesd.*vulnerability-detector.*download.*access\.redhat\.com.*after=(.*)-.*-.*'
    download_redhat_from_match = re.match(download_redhat_from_msg, line)

    download_nvd_from_match = re.match(nvd_check_feed_download_regex, line)

    if download_redhat_from_match is not None:
        return int(download_redhat_from_match.group(1))
    elif download_nvd_from_match is not None:
        return int(download_nvd_from_match.group(1))
    else:
        return None


def callback_detect_vulnerability_detector_disabled(line):
    msg = r'(.*)wazuh-modulesd:vulnerability-detector(.*)DEBUG: Module disabled. Exiting...'
    match = re.match(msg, line)

    return match is not None


def callback_detect_vulnerability_detector_enabled(line):
    msg = r'(.*)wazuh-modulesd:vulnerability-detector(.*)'
    match1 = re.match(msg, line)
    msg = r'(.*)DEBUG: Module disabled. Exiting...(.*)'
    match2 = re.match(msg, line)

    return match1 is not None and match2 is None


def make_vuln_callback(pattern):
    """
    Creates a callback function from a text pattern.

    It already contains the vulnerability-detector prefix.

    Parameters
    ----------
    pattern : str
        String to match on the log

    >>> callback_bionic_update_started = make_callback("Starting Ubuntu Bionic database update")
    """
    pattern = r'\s+'.join(pattern.split())
    regex = re.compile(r'{}{}'.format(vulnerability_detector_prefix, pattern))

    return lambda line: regex.match(line) is not None
